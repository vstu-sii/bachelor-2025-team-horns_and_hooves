{% extends 'home.html' %}
{% load static %}
{% block title %}
    Статистика сна
{% endblock %}

{% block content %}
    <div class="container my-5">
        {# ---------- ХРОНОТИП ---------- #}
        {% if metric.chronotype %}
            {% for k, v in metric.chronotype.items %}
                {% if k != 'img' %}
                    <div class="card profile-card border-0 shadow-sm">
                        <div class="card-body">
                            <div class="d-flex align-items-center justify-content-between mb-2">
                                <h2 class="display-3 mb-0">Ваш хронотип —
                                    {% if k == 'skylark' %}Жаворонок
                                    {% elif k == 'pigeon' %}Голубь
                                    {% elif k == 'owl' %}Сова
                                    {% else %}—{% endif %}
                                </h2>
                                <a href="{% url 'sleep_chronotype' %}" class="ml-3 d-inline-flex align-items-center"
                                   aria-label="Подробнее о хронотипах">
                                    <i class="bi bi-chevron-right h2 mb-0"></i>
                                </a>
                            </div>

                            <div class="row align-items-center">
                                <div class="col-sm-4 col-md-3 mb-3 mb-sm-0 text-center">
                                    {% if metric.chronotype.img %}
                                        <img src="{% static 'image/' %}{{ metric.chronotype.img }}" alt="{{ k }}"
                                             class="img-fluid rounded" style="max-height: 300px; object-fit: contain;">
                                    {% else %}
                                        <div class="text-muted small">Иллюстрация хронотипа отсутствует</div>
                                    {% endif %}
                                </div>

                                <div class="col-sm-8 col-md-9">
                                    <h4 class="mb-0 text-muted">{{ v }}</h4>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endif %}
            {% endfor %}
        {% else %}
            <div class="alert alert-info">Хронотип ещё не определён — недостаточно данных.
            </div>
        {% endif %}

        {# ---------- РЕКОМЕНДАЦИИ ---------- #}
        <div class="card profile-card border-0 shadow-sm mt-4">
            <div class="profile-header profile-header--amber">
                <div class="profile-avatar profile-avatar--amber"><i class="bi bi-lightbulb"></i></div>
                <div>
                    <h5 class="mb-0">Мы советуем</h5>
                    <div class="text-muted">Персональные рекомендации по улучшению сна</div>
                </div>
            </div>

            <div class="card-body">
                <div class="recommendation-content" id="recommendation-block">
                    {% if rec %}
                        {{ rec|linebreaksbr }}
                        <div class="mt-3">
                            Эффективность вашего сна составляет <strong>{{ metric.sleep_efficiency }}%</strong>.
                        </div>
                    {% elif task_id %}
                        <p class="text-muted">Рекомендации обрабатываются… Обновление будет автоматически.</p>
                    {% else %}
                        <p class="text-muted">Пока у нас нет персональных рекомендаций — необходимо как минимум одно
                            измерение сна.</p>
                    {% endif %}
                </div>
            </div>
        </div>

        {# ---------- АНАЛИЗ: "Столько вы спали в последний день" (пирог фаз и метрики) ---------- #}
        <div class="card profile-card border-0 shadow-sm mt-4">
            <div class="profile-header profile-header--indigo">
                <div class="profile-avatar profile-avatar--indigo"><i class="bi bi-moon-stars"></i></div>
                <div>
                    <h5 class="mb-0">Столько вы спали в последний день</h5>
                    <div class="text-muted">Анализ продолжительности и качества сна</div>
                </div>
            </div>

            <div class="card-body">
                <div class="row">
                    <div class="col-lg-6 mb-3 mb-lg-0">
                        {% if plot_data.phases %}
                            <div id="graph-Phase"></div>
                        {% else %}
                            <div class="alert alert-light small">
                                <i class="bi bi-info-circle me-2"></i>
                                Недостаточно данных, чтобы показать распределение фаз сна. Добавьте запись о сне, и мы
                                покажем подробный разбор.
                            </div>
                            <div id="graph-Phase" style="display:none;"></div>
                        {% endif %}
                    </div>

                    <div class="col-lg-6">
                        <p class="text-muted mb-4">
                            Регулярность сна показывает, насколько стабильно вы ложитесь спать и просыпаетесь.
                        </p>
                        <p class="text-muted mb-4">
                            Разброс времени отбоя и подъёма — это стандартное отклонение в минутах: чем меньше значение,
                            тем стабильнее ваш режим сна.
                        </p>

                        {% if metric.sleep_regularity %}
                            <ul class="list-unstyled mb-3">
                                <li class="mb-2"><i class="bi bi-alarm mr-2 text-primary"></i>
                                    Разброс времени отбоя:
                                    <strong>{{ metric.sleep_regularity.bedtime_std }}</strong> мин
                                </li>
                                <li class="mb-2"><i class="bi bi-sunrise mr-2 text-warning"></i>
                                    Разброс времени подъёма:
                                    <strong>{{ metric.sleep_regularity.wake_time_std }}</strong> мин
                                </li>
                            </ul>
                        {% else %}
                            <div class="alert alert-light small">Недостаточно записей, чтобы посчитать регулярность
                                сна.
                            </div>
                        {% endif %}

                        <div class="mb-4">
                            <span class="badge-soft badge-soft--day mr-2">Цель: &lt; 30 мин</span>
                            <span class="badge-soft badge-soft--night">Лучше ложиться и вставать в одно и то же время</span>
                        </div>

                        <ul class="list-unstyled mb-4">
                            <li class="mb-2"><i class="bi bi-fire mr-2 text-danger"></i>
                                Вы сожгли
                                <strong>
                                    {% if metric.calories_burned is not None %}
                                        {{ metric.calories_burned }}
                                    {% else %}
                                        —
                                    {% endif %}
                                </strong> ккал
                            </li>
                        </ul>

                        <p class="mt-3 mb-2 text-muted small d-flex align-items-center">
                            <strong>Узнать больше о других метриках</strong>
                            <a href="{% url 'sleep_history' %}" class="ml-2 d-inline-flex align-items-center">
                                подробнее <i class="bi bi-chevron-right ml-1"></i>
                            </a>
                        </p>
                    </div>
                </div>
            </div>
        </div>

        {# ---------- ПУЛЬС ЗА НОЧЬ ---------- #}
        <div class="card profile-card border-0 shadow-sm mt-4">
            <div class="profile-header profile-header--rose">
                <div class="profile-avatar profile-avatar--rose"><i class="bi bi-heart-pulse"></i></div>
                <div>
                    <h5 class="mb-0">Ваш пульс за последнюю ночь</h5>
                    <div class="text-muted">Временной ряд и распределение частоты сердечных сокращений</div>
                </div>
            </div>

            <div class="card-body">
                <div class="row">
                    <div class="col-lg-6 mb-3 mb-lg-0">
                        {% if plot_data.heart_rate.date %}
                            <div id="graph-BPM"></div>
                        {% else %}
                            <div class="alert alert-light small">
                                <i class="bi bi-info-circle me-2"></i>
                                Нет данных пульса за последнюю ночь.
                            </div>
                            <div id="graph-BPM" style="display:none;"></div>
                        {% endif %}
                    </div>

                    <div class="col-lg-6">
                        <h5 class="h6 mb-3">Анализ пульса во время сна</h5>
                        <p class="text-muted mb-3">
                            На графике отображены замеры вашего пульса в течение ночи. Каждая точка показывает частоту
                            сердечных сокращений в определённый момент времени.
                            <br><br>
                            Колоколообразная кривая демонстрирует плотность распределения значений пульса, что помогает
                            выявить наиболее типичные показатели.
                        </p>

                        <div class="mb-3">
                            <p class="small text-muted mb-2">Диапазоны пульса:</p>
                            <div class="d-flex flex-wrap gap-2">
                                <span class="badge-soft badge-soft--day">Норма сна: 50–70 уд/мин</span>
                                <span class="badge-soft badge-soft--sun">Повышенный: 70–90 уд/мин</span>
                                <span class="badge-soft badge-soft--night">Высокий: &gt; 90 уд/мин</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {# ---------- ДЛИТЕЛЬНОСТЬ СНА: ГРАФИК ЗА ПЕРИОД ---------- #}
        <div class="card profile-card border-0 shadow-sm mt-4">
            <div class="profile-header profile-header--teal d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-right">
                    <div class="profile-avatar profile-avatar--teal"><i class="bi bi-graph-up"></i></div>
                    <div>
                        <h5 class="mb-0">Анализ продолжительности сна</h5>
                        <div class="text-muted" id="sleep-graph-title">
                            {% if plot_data.first_date and plot_data.last_date %}
                                Тенденции и статистика вашего сна с {{ plot_data.first_date }} по
                                {{ plot_data.last_date }}
                            {% else %}
                                Тенденции и статистика (недостаточно данных для периода)
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div id="pagination" class="d-flex gap-2">

                    {% if prev_cursor %}
                        <a href="#" id="prev-btn" class="btn btn-sm btn-outline-secondary"
                           data-cursor="{{ prev_cursor }}"><i
                                class="bi bi-chevron-left"></i></a>
                    {% endif %}
                    {% if next_cursor %}
                        <a href="#" id="next-btn" class="btn btn-sm btn-outline-secondary"
                           data-cursor="{{ next_cursor }}"><i class="bi bi-chevron-right"></i></a>
                    {% endif %}
                </div>
            </div>

            <div class="card-body">
                <div class="row">
                    <div class="col-lg-6 mb-3 mb-lg-0">
                        {% if plot_data.graph_data.dates %}
                            <div id="graph-Duration"></div>
                        {% else %}
                            <div class="alert alert-light small">
                                <i class="bi bi-info-circle me-2"></i>
                                Недостаточно данных для отображения графика продолжительности сна. Запишите не менее
                                одного дня сна.
                            </div>
                            <div id="graph-Duration" style="display:none;"></div>
                        {% endif %}
                    </div>

                    <div class="col-lg-5">
                        <div class="sleep-stats-description">
                            <p>На этом графике показана динамика продолжительности вашего сна за выбранный период.</p>

                            <p class="mb-4">Средняя продолжительность сна за этот период:
                                <strong class="text-primary" id="avg_duration">
                                    {% if metric.avg_sleep_duration %}
                                        {{ metric.avg_sleep_duration|safe }} часов.
                                    {% else %}
                                        0 часов.
                                    {% endif %}
                                </strong>
                            </p>

                            <div class="mb-4">
                                <p class="small text-muted mb-2">Выберите период анализа:</p>
                                <div class="d-flex flex-wrap gap-2" id="mode-buttons">
                                    <button type="button"
                                            class="sleep-mode-btn mode-btn {% if page_size == 7 %}active{% endif %}"
                                            data-mode="week">
                                        <i class="bi bi-calendar-week me-1"></i> Неделя
                                    </button>
                                    <button type="button"
                                            class="sleep-mode-btn mode-btn {% if page_size == 30 %}active{% endif %}"
                                            data-mode="month">
                                        <i class="bi bi-calendar-month me-1"></i> Месяц
                                    </button>
                                </div>
                            </div>

                            <div class="alert alert-light border small">
                                <i class="bi bi-info-circle text-primary me-2"></i>
                                Для здорового сна взрослому человеку рекомендуется спать <strong>7 - 9 часов (420 - 540
                                мин)</strong> в сутки.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
{% endblock %}


{% block scripts %}
    <script src="https://cdn.jsdelivr.net/npm/highcharts@11/highcharts.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highcharts@11/modules/variable-pie.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highcharts@11/modules/histogram-bellcurve.js"></script>
    
    {# Передаём plot_data и метрики в JS — если plot_data пустой, JS должен корректно обработать это. #}
    <script>

        const sleepRecordAJAXUrl = "{% url 'sleep_statistics_show' %}";
        const initialGraphData = {{ plot_data|safe }};
        let initialAvgDuration = {{ metric.avg_sleep_duration|safe }};
        let currentPageSize = {{ page_size|default:7 }};
    </script>

    <script src="{% static 'javascript/sleep_statistic_graphs.js' %}"></script>
    <script src="{% static 'javascript/sleep_statistics_poll.js' %}"></script>
{% endblock %}
