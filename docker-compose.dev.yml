services:
  # Основной сервис Django-приложения.
  # Здесь запускается веб-бэкенд: сначала проверяется готовность базы данных,
  # затем применяются миграции, собираются статические файлы,
  # и в конце запускается Gunicorn — это продакшн-сервер для Django.
  web:
    build:
      context: .
      dockerfile: Dockerfile
    command: >
      sh -c "python manage.py migrate &&
             python manage.py collectstatic --no-input &&
             gunicorn --bind 0.0.0.0:8000 sleepproject.wsgi:application"
    volumes:
      - .:/app                        # Монтируем весь проект внутрь контейнера
      - static_volume:/app/static     # Том для хранения статических файлов (CSS, JS, картинки)
      - media_volume:/app/media       # Том для хранения медиафайлов (загрузки пользователей)
    ports:
      - "8000:8000"                   # Пробрасываем порт 8000 наружу, чтобы открыть сайт
    env_file:
      - .env                          # Подключаем переменные окружения из файла .env
    depends_on:
      - db                            # Ждём готовности базы данных PostgreSQL
      - redis                         # Ждём готовности Redis
    restart: unless-stopped           # Автоматический перезапуск при сбое
    logging:                          # Отправляем логи в Loki
      driver: "loki"
      options:
        loki-url: "http://loki:3100/loki/api/v1/push"
        loki-external-labels: "container_name={{.Name}},service=web"
    networks:
      - default
      - monitoring

  # Celery worker — обработчик асинхронных задач.
  # Здесь выполняются фоновые задачи: анализ сна, импорт CSV, расчёты.
  celery:
    build:
      context: .
      dockerfile: Dockerfile
    command: >
      sh -c "celery -A sleepproject worker --loglevel=info"
    volumes:
      - .:/app                        # Монтируем проект внутрь контейнера
    env_file:
      - .env                          # Подключаем переменные окружения
    depends_on:
      - db
      - redis
    restart: unless-stopped

  # Celery beat — планировщик периодических задач.
  # Отвечает за регулярные задания: рассылка уведомлений.
  celery-beat:
    build:
      context: .
      dockerfile: Dockerfile
    command: >
      sh -c "celery -A sleepproject beat --loglevel=info"
    volumes:
      - .:/app
    env_file:
      - .env
    depends_on:
      - db
      - redis
    restart: unless-stopped

  # PostgreSQL — база данных.
  # Хранит все данные пользователей, записи сна, статистику и результаты анализа.
  db:
    image: postgres:15.4
    volumes:
      - postgres_data:/var/lib/postgresql/data/   # Том для хранения данных базы
    environment:
      - POSTGRES_DB=${BD_NAME}                    # Имя базы (из .env)
      - POSTGRES_USER=${BD_USER}                  # Пользователь базы (из .env)
      - POSTGRES_PASSWORD=${BD_PASSWORD}          # Пароль (из .env)
    ports:
      - "5432:5432"                              
    restart: unless-stopped
    logging:
      driver: "loki"
      options:
        loki-url: "http://loki:3100/loki/api/v1/push"
        loki-external-labels: "container_name={{.Name}},service=postgres"
    networks:
      - default
      - monitoring

  # Redis — брокер сообщений и кэш.
  # Используется для очередей задач Celery и для кэширования данных в Django.
  redis:
    image: redis:7.2
    ports:
      - "6379:6379"                              
    volumes:
      - redis_data:/data                          # Том для хранения данных Redis
    restart: unless-stopped
    logging:
      driver: "loki"
      options:                                    # Отправляем логи в Loki
        loki-url: "http://loki:3100/loki/api/v1/push"
        loki-external-labels: "container_name={{.Name}},service=redis"
    networks:
      - default
      - monitoring

  # Nginx — фронтовой веб-сервер.
  # Отвечает за отдачу статических и медиафайлов, а также проксирует запросы к Django.
  nginx:
    image: nginx:1.25
    ports:
      - "80:80"                                   # Проброс порта HTTP (доступ к сайту по адресу localhost:80)
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/conf.d/default.conf  # Конфигурация Nginx
      - static_volume:/app/static                 # Том со статикой
      - media_volume:/app/media                   # Том с медиафайлами
    depends_on:
      - web                                       # Ждём готовности Django-приложения
    restart: unless-stopped
    logging:                                      # Отправляем логи в Loki
      driver: "loki"
      options:
        loki-url: "http://loki:3100/loki/api/v1/push"
        loki-external-labels: "container_name={{.Name}},service=nginx"
  
  # Ollama — вторая модель ИИ с архитектурой RAG.
  ollama:
    image: ollama/ollama:0.9.6
    container_name: ollama
    expose:
      - 11434                                     # Порт Ollama доступен внутри сети
    volumes:
      - ./.ollama_data:/root/.ollama              # Том для хранения моделей Ollama
    networks:
      - devserver
    restart: unless-stopped
    # Для использования GPU:
    # deploy:
    #   resources:
    #     reservations:
    #       devices:
    #         - driver: nvidia
    #           count: all
    #           capabilities: [gpu]

# Определение томов для хранения данных
volumes:
  postgres_data:   # Том для хранения данных PostgreSQL
  redis_data:      # Том для хранения данных Redis
  static_volume:   # Том для хранения статических файлов Django
  media_volume:    # Том для хранения медиафайлов Django

networks:
  monitoring:
    external: true