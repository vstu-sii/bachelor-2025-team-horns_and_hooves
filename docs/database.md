
---

### **Таблица auth_user**

| Поле           | Тип данных   | Описание                                | Индексы       |
| -------------- | ------------ | --------------------------------------- | ------------- |
| `id`           | INTEGER (PK) | Уникальный идентификатор пользователя   | PK            |
| `password`     | VARCHAR(128) | Хеш пароля                              | –             |
| `last_login`   | TIMESTAMP    | Время последнего входа (with time zone) | –             |
| `is_superuser` | BOOLEAN      | Флаг суперпользователя                  | INDEX         |
| `username`     | VARCHAR(150) | Имя пользователя (логин)                | INDEX/UNIQUE* |
| `first_name`   | VARCHAR(150) | Имя                                     | INDEX         |
| `last_name`    | VARCHAR(150) | Фамилия                                 | INDEX         |
| `email`        | VARCHAR(254) | Электронная почта                       | INDEX/UNIQUE* |
| `is_staff`     | BOOLEAN      | Флаг персонала                          | INDEX         |
| `is_active`    | BOOLEAN      | Активен ли аккаунт                      | INDEX         |
| `date_joined`  | TIMESTAMP    | Дата регистрации (with time zone)       | INDEX         |



---

### **Таблица auth_group**

| Поле   | Тип данных   | Описание                 | Индексы       |
| ------ | ------------ | ------------------------ | ------------- |
| `id`   | INTEGER (PK) | Уникальный идентификатор | PK            |
| `name` | VARCHAR(150) | Название группы          | INDEX/UNIQUE* |

*Часто `name` уникален для групп.

---

### **Таблица auth_permission**

| Поле              | Тип данных   | Описание                                  | Индексы        |
| ----------------- | ------------ | ----------------------------------------- | -------------- |
| `id`              | INTEGER (PK) | Уникальный идентификатор права            | PK             |
| `name`            | VARCHAR(255) | Название права                            | INDEX          |
| `content_type_id` | INTEGER (FK) | Тип контента → `django_content_type.id`   | INDEX, FK      |
| `codename`        | VARCHAR(100) | Машинное имя права (например, 'add_user') | INDEX, UNIQUE* |



---

### **Таблица auth_user_groups**

| Поле       | Тип данных   | Описание                               | Индексы   |
| ---------- | ------------ | -------------------------------------- | --------- |
| `id`       | BIGINT (PK)  | Уникальный идентификатор записи (join) | PK        |
| `user_id`  | INTEGER (FK) | Пользователь → `auth_user.id`          | INDEX, FK |
| `group_id` | INTEGER (FK) | Группа → `auth_group.id`               | INDEX, FK |

---

### **Таблица auth_group_permissions**

| Поле            | Тип данных   | Описание                               | Индексы   |
| --------------- | ------------ | -------------------------------------- | --------- |
| `id`            | BIGINT (PK)  | Уникальный идентификатор записи (join) | PK        |
| `group_id`      | INTEGER (FK) | Группа → `auth_group.id`               | INDEX, FK |
| `permission_id` | INTEGER (FK) | Право → `auth_permission.id`           | INDEX, FK |

---

### **Таблица auth_user_user_permissions**

| Поле            | Тип данных   | Описание                               | Индексы   |
| --------------- | ------------ | -------------------------------------- | --------- |
| `id`            | BIGINT (PK)  | Уникальный идентификатор записи (join) | PK        |
| `user_id`       | INTEGER (FK) | Пользователь → `auth_user.id`          | INDEX, FK |
| `permission_id` | INTEGER (FK) | Право → `auth_permission.id`           | INDEX, FK |

---

### **Таблица django_content_type**

| Поле        | Тип данных   | Описание                 | Индексы |
| ----------- | ------------ | ------------------------ | ------- |
| `id`        | INTEGER (PK) | Уникальный идентификатор | PK      |
| `app_label` | VARCHAR(100) | Имя приложения           | INDEX   |
| `model`     | VARCHAR(100) | Имя модели               | INDEX   |

---

### **Таблица django_admin_log**

| Поле              | Тип данных   | Описание                                              | Индексы   |
| ----------------- | ------------ | ----------------------------------------------------- | --------- |
| `id`              | INTEGER (PK) | Уникальный идентификатор записи в логе админа         | PK        |
| `action_time`     | TIMESTAMP    | Время действия (with time zone)                       | INDEX     |
| `object_id`       | TEXT         | id объекта (строка)                                   | –         |
| `object_repr`     | VARCHAR(200) | Отображение объекта (человекочитаемо)                 | –         |
| `action_flag`     | SMALLINT     | Код действия (добавление/изменение/удаление)          | INDEX     |
| `change_message`  | TEXT         | Описание изменений                                    | –         |
| `content_type_id` | INTEGER (FK) | Тип контента → `django_content_type.id`               | INDEX, FK |
| `user_id`         | INTEGER (FK) | Пользователь → `auth_user.id` (кто совершил действие) | INDEX, FK |

---

### **Таблица django_celery_progress_task**

| Поле             | Тип данных   | Описание                                        | Индексы       |
| ---------------- | ------------ | ----------------------------------------------- | ------------- |
| `id`             | BIGINT (PK)  | Уникальный идентификатор                        | PK            |
| `uuid`           | UUID         | UUID задачи                                     | INDEX/UNIQUE* |
| `name`           | VARCHAR(128) | Имя задачи                                      | INDEX         |
| `status`         | VARCHAR(128) | Статус выполнения (pending/started/success/...) | INDEX         |
| `result`         | TEXT         | Результат (json/text)                           | –             |
| `exception`      | VARCHAR(128) | Текст исключения                                | –             |
| `traceback`      | TEXT         | Стек исключения                                 | –             |
| `date_created`   | TIMESTAMP    | Время создания                                  | INDEX         |
| `date_completed` | TIMESTAMP    | Время завершения                                | INDEX         |



---

### **Таблица django_migrations**

| Поле      | Тип данных   | Описание                  | Индексы |
| --------- | ------------ | ------------------------- | ------- |
| `id`      | BIGINT (PK)  | Уникальный идентификатор  | PK      |
| `app`     | VARCHAR(255) | Имя приложения            | INDEX   |
| `name`    | VARCHAR(255) | Имя миграции              | INDEX   |
| `applied` | TIMESTAMP    | Время применения миграции | INDEX   |

---

### **Таблица django_session**

| Поле           | Тип данных     | Описание                                      | Индексы |
| -------------- | -------------- | --------------------------------------------- | ------- |
| `session_key`  | VARCHAR(40) PK | Ключ сессии (PK)                              | PK      |
| `session_data` | TEXT           | Данные сессии (зашифрованные/сериализованные) | –       |
| `expire_date`  | TIMESTAMP      | Время истечения сессии                        | INDEX   |

---

### **Таблица sleep_tracking_app_userdata**

| Поле            | Тип данных   | Описание                                          | Индексы           |
| --------------- | ------------ | ------------------------------------------------- | ----------------- |
| `id`            | BIGINT (PK)  | Уникальный идентификатор                          | PK                |
| `user_id`       | INTEGER (FK) | Пользователь → `auth_user.id` (OneToOne в модели) | UNIQUE, INDEX, FK |
| `date_of_birth` | DATE         | Дата рождения                                     | –                 |
| `weight`        | DOUBLE       | Вес (в кг)                                        | –                 |
| `gender`        | SMALLINT     | Пол (0 — женщина, 1 — мужчина)                    | INDEX             |
| `height`        | SMALLINT     | Рост (в см)                                       | –                 |
| `active`        | BOOLEAN      | Активность пользователя (флаг)                    | INDEX             |



---

### **Таблица sleep_tracking_app_sleeprecord**

| Поле                   | Тип данных   | Описание                                  | Индексы   |
| ---------------------- | ------------ | ----------------------------------------- | --------- |
| `id`                   | BIGINT (PK)  | Уникальный идентификатор записи сна       | PK        |
| `user_id`              | INTEGER (FK) | Пользователь → `auth_user.id`             | INDEX, FK |
| `sleep_date_time`      | TIMESTAMP    | Дата/время записи сна (db_index в модели) | INDEX     |
| `sleep_rem_duration`   | SMALLINT     | Длительность REM в минутах                | –         |
| `has_rem`              | BOOLEAN      | Была ли фаза REM в записи                 | –         |
| `min_hr`               | SMALLINT     | Минимальный пульс за сон                  | –         |
| `device_bedtime`       | TIMESTAMP    | Время фиксации начала сна устройством     | –         |
| `sleep_deep_duration`  | SMALLINT     | Длительность глубокого сна (мин)          | –         |
| `wake_up_time`         | TIMESTAMP    | Время пробуждения (по данным устройства)  | –         |
| `bedtime`              | TIMESTAMP    | Время, когда пользователь лег спать       | –         |
| `awake_count`          | SMALLINT     | Кол-во пробуждений                        | –         |
| `duration`             | SMALLINT     | Общая длительность сна (мин)              | –         |
| `max_hr`               | SMALLINT     | Максимальный пульс за сон                 | –         |
| `sleep_awake_duration` | SMALLINT     | Время бодрствования в минутах             | –         |
| `avg_hr`               | NUMERIC(5,2) | Средний пульс                             | –         |
| `sleep_light_duration` | SMALLINT     | Длительность лёгкой фазы сна (мин)        | –         |
| `device_wake_up_time`  | TIMESTAMP    | Время фиксации пробуждения устройством    | –         |
| `total_time_bed`       | NUMERIC(5,2) | Общее время в кровати                     | –         |



---

### **Таблица sleep_tracking_app_nightheartrateentry**

| Поле        | Тип данных  | Описание                                         | Индексы   |
| ----------- | ----------- | ------------------------------------------------ | --------- |
| `id`        | BIGINT (PK) | Уникальный идентификатор                         | PK        |
| `record_id` | BIGINT (FK) | Запись сна → `sleep_tracking_app_sleeprecord.id` | INDEX, FK |
| `time`      | TIMESTAMP   | Время измерения пульса                           | INDEX     |
| `bpm`       | SMALLINT    | Пульс (уд/мин)                                   | –         |

---

### **Таблица sleep_tracking_app_sleepsegment**

| Поле         | Тип данных  | Описание                                          | Индексы   |
| ------------ | ----------- | ------------------------------------------------- | --------- |
| `id`         | BIGINT (PK) | Уникальный идентификатор                          | PK        |
| `record_id`  | BIGINT (FK) | Запись сна → `sleep_tracking_app_sleeprecord.id`  | INDEX, FK |
| `start_time` | TIMESTAMP   | Время начала сегмента                             | INDEX     |
| `end_time`   | TIMESTAMP   | Время конца сегмента                              | INDEX     |
| `state`      | SMALLINT    | Состояние сегмента (2—Light,3—Deep,4—REM,5—Awake) | INDEX     |

---

### **Таблица sleep_tracking_app_sleepstatistics**

| Поле                        | Тип данных   | Описание                                                 | Индексы          |
| --------------------------- | ------------ | -------------------------------------------------------- | ---------------- |
| `id`                        | BIGINT (PK)  | Уникальный идентификатор                                 | PK               |
| `user_id`                   | INTEGER (FK) | Пользователь → `auth_user.id`                            | INDEX, FK        |
| `date`                      | DATE         | Дата, к которой относятся статистики (db_index в модели) | INDEX (db_index) |
| `latency_minutes`           | DOUBLE       | Латентность сна в минутах                                | –                |
| `sleep_efficiency`          | DOUBLE       | Эффективность сна (в %)                                  | –                |
| `sleep_phases`              | JSONB        | Процент каждой фазы/структура фаз                        | –                |
| `sleep_fragmentation_index` | DOUBLE       | Индекс фрагментации сна                                  | –                |
| `sleep_calories_burned`     | DOUBLE       | Калории за сон                                           | –                |
| `sleep_duration`            | SMALLINT     | Длительность сна (мин)                                   | –                |
| `sleep_quality`             | DOUBLE       | Оценка качества (результат первой модели)                | –                |
| `health_impact`             | VARCHAR(255) | Описание влияния на здоровье                             | –                |
| `calories_burned`           | DOUBLE       | Доп. поле с калориями                                    | –                |
| `recommended`               | TEXT         | Рекомендации (вторая модель ИИ)                          | –                |

---



# Формат данных для взаимодействия с AI-сервисом


**Логика работы**

1. **Сбор данных пользователя:**
   Пользователь (сущность `User`) синхронизирует данные сна через приложение. Сервер сохраняет их в следующие таблицы:

   * `SleepRecord` — запись сна за ночь.
   * `NightHeartRateEntry` — пульс пользователя ночью, привязанный к `SleepRecord`.
   * `SleepSegment` — сегменты сна (легкий, глубокий, REM, бодрствование) для каждой записи сна.
   * `SleepStatistics` — агрегированные показатели сна за день (эффективность, фазы и др.).
   * `UserData` — информация о пользователе (дата рождения, вес, рост, пол).

2. **Формирование промпта для AI:**
   Сервер извлекает историю сна пользователя:

   * Все записи `SleepRecord` и связанные `NightHeartRateEntry` и `SleepSegment` за выбранный период.
   * Агрегированные данные `SleepStatistics` (эффективность, качество сна, рекомендации).
   * Профиль пользователя из `UserData` (возраст, рост, вес, пол).

3. **Отправка запроса к AI-сервису:**
   Сервер отправляет JSON-запрос к AI-сервису.

4. **Получение ответа от AI:**

   * AI-сервис возвращает JSON с анализом сна и рекомендациями.
   * Сервер сохраняет результат в `SleepStatistics` (в поле `recommended` и `sleep_quality`).
   * Ответ возвращается пользователю через AJAX запрос, чтобы обновить интерфейс приложения, без принудительного обновления страницы.

### Пример JSON-запроса

---

### Модель 1: Оценка качества сна 

**Цель:** Анализ последней ночи сна, формирование оценки (0–100) и текстовой сводки.

**Пример запроса JSON к AI:**

```json
{
    "user_id": 1,
    "last_sleep_record": {
        "sleep_date_time": "2025-11-08T23:00:00Z",
        "duration": 420,
        "sleep_rem_duration": 90,
        "sleep_deep_duration": 120,
        "sleep_light_duration": 210,
        "awake_count": 3,
        "min_hr": 52,
        "max_hr": 88,
        "avg_hr": 68.5,
        "device_bedtime": "2025-11-08T22:50:00Z",
        "device_wake_up_time": "2025-11-09T06:50:00Z"
    },
    "night_hr_entries": [
        {"time": "2025-11-08T23:30:00Z", "bpm": 60},
        {"time": "2025-11-08T24:00:00Z", "bpm": 58},
        {"time": "2025-11-09T06:30:00Z", "bpm": 72}
    ],
    "sleep_segments": [
        {"start_time": "2025-11-08T23:00:00Z", "end_time": "2025-11-08T23:45:00Z", "state": 2},
        {"start_time": "2025-11-08T23:45:00Z", "end_time": "2025-11-09T01:45:00Z", "state": 3},
        {"start_time": "2025-11-09T01:45:00Z", "end_time": "2025-11-09T03:15:00Z", "state": 4}
    ]
}
```

**Пример ответа JSON от Модели 1:**

```json
{
    "sleep_quality_score": 78.5,
    "summary": "Сон был относительно спокойным, с достаточной продолжительностью глубокого и REM-сна. Частота пробуждений средняя, общее качество сна хорошее."
}
```

> Результат сохраняется в `SleepStatistics` (поля `sleep_quality`) и используется для следующей модели.

---

### Модель 2: Генерация рекомендаций

**Цель:** Использовать сводку от Модели 1 и данные за последние 7 дней, извлечь релевантные научные материалы и сгенерировать персональные рекомендации.

**Пример запроса JSON к AI:**

```json
{
    "user_id": 1,
    "last_7_days_sleep_statistics": [
        {"date": "2025-11-02", "sleep_quality_score": 72, "summary": "Сон с частыми пробуждениями."},
        {"date": "2025-11-03", "sleep_quality_score": 80, "summary": "Сон хороший, REM-сон полноценный."},
        {"date": "2025-11-04", "sleep_quality_score": 75, "summary": "Сон средний, много легкого сна."},
        {"date": "2025-11-05", "sleep_quality_score": 78, "summary": "Сон улучшился, меньше пробуждений."},
        {"date": "2025-11-06", "sleep_quality_score": 74, "summary": "Сон с краткими пробуждениями."},
        {"date": "2025-11-07", "sleep_quality_score": 79, "summary": "Сон стабильный, REM-фаза нормальная."},
        {"date": "2025-11-08", "sleep_quality_score": 78.5, "summary": "Сон хороший, согласно последней оценке Модели 1."}
    ],
    "last_model_summary": "Сон был относительно спокойным, с достаточной продолжительностью глубокого и REM-сна. Частота пробуждений средняя, общее качество сна хорошее.",
    "user_profile": {
        "date_of_birth": "1990-05-15",
        "weight": 70.5,
        "height": 175,
        "gender": "Мужской"
    }
}
```

**Пример ответа JSON от Модели 2:**

```json
{
    "personalized_recommendations": "Рекомендуется ложиться спать на 30 минут раньше, уменьшить использование гаджетов перед сном и добавить легкую вечернюю растяжку. Ожидаемый эффект: повышение качества сна на 5-7% в течение недели.",
}
```

> Результат сохраняется в профиле пользователя (`SleepStatistics.recommended`), чтобы показывать персональные советы в приложении.

---


