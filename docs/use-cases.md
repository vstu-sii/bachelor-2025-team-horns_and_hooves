
# D2 — Use-case Narrative

## Happy Path

**Условия**

- Пользователь зарегистрирован и авторизован;
- доступны данные сна (минимум 1 ночь для оценки дня и 7 дней для рекомендаций);
- Сервисы приложения работоспособны.

Вход и доступ:

- Пользователь проходит регистрацию и авторизуется.
- После входа попадает на раздел загрузки/статистики сна.

Массовая загрузка данных:

- По инструкции пользователь загружает пакет статистики сна.
- Система валидирует формат

Расчёт метрик:

- Бэкенд агрегирует данные и вычисляет KPI сна (общая длительность, пробуждения, доли фаз, вариабельность пульса и др.).

Аналитика двумя моделями:

- Модель 1 (оценка предыдущей ночи): анализирует последнюю ночь и выдает итог — хорошо / удовлетворительно / плохо 
- Модель 2 собирает статистику за последние 7 дней, включая результат первой модели и формирует персональные рекомендации по улучшению сна.

Генерация отчёта:

- Система собирает выводы моделей и метрики в единый отчёт: сводка за ночь, недельные тренды, список действий.

## Alternate Flows

### Alternative Flows 1

**Условия** - Пользователь не авторизован и пытается загрузить данные

**Триггер**: переход по URL загрузки/статистики без активной сессии (или сессия истекла).

**Обнаружение**: система видит отсутствие/некорректность токена.

**Переадресация**: автоматический редирект на страницу входа с сохранением целевого адреса.

**User Value**:  безопасность данных и бесшовный возврат на целевую страницу после авторизации.

### Alternative Flows 2

**Условия** - Пользователь хочет посмотреть статистику без загрузки данных

**Триггер**: открытие страницы статистики при отсутствии данных или их неполноте.

**Обнаружение** - валидатор определяет:

    для Модели 1 — нет как минимум 1 ночи;
    для Модели 2 — меньше 7 последовательных дней.

    В каждой карточке метрики и в блоках моделей показывается текст: «Недостаточно данных».

**Частичная работа**: Если данных для расчёта или генерации оценки сна достаточно, происходит расчёт

**User Value**:  экономия времени (сразу понятно, что нужно сделать), снижение ошибок благодаря явным требованиям к данным, постепенная польза даже при частичном наборе.

## Error Handling

### Error Handling 1 — Некорректный ввод данных (CSV/формы)

**Триггер**: Пользователь загружает CSV с неверной структурой, датами в будущем/прошлом вне диапазона, дубликатами, пустыми значениями метрик, или превышает допустимый размер файла.

**Обнаружение**: Валидация на стороне сервера и при разборе (проверка заголовков столбцов, типов, диапазонов). Ограничение размера и типа файла на уровне Django и фронтенда.

**Обработка**: Блокировка сохранения, возврат формы с подсветкой полей и конкретными сообщениями.

**User Value**:  Экономия времени: частичный импорт валидных строк без полной остановки процесса.

### Error Handling 2 — Технический сбой фоновой обработки (Redis/Celery/БД)

**Триггер**: Недоступен Redis, Celery-воркер остановлен, таймаут при вычислении метрик, временная ошибка БД.

**Обнаружение**: Исключения подключения к Redis. Таймауты теневых задач.

**Обработка**: Авто-ретраи задач с экспоненциальной задержкой и максимальным числом попыток.

**Уведомление пользователей**: Пользователь получит ответ автоматически.

**User Value**: ретраи и очереди не требуют действий пользователя, а  данные/прогресс не теряются при сбоях.

### Error Handling 3 — Превышение лимитов/высокая нагрузка (Highcharts/клиент/сервер)

**Триггер**: Очень большой объём точек для графиков (Highcharts), частые запросы обновления, тяжелые выборки истории сна, одновременные пользователи.

**Обнаружение**: Замеры времени выполнения IO запросы через Django Debug Toolbar.

**Обработка**: Кэширование ответов через Redis. Отключение тяжёлых эффектов Highcharts при больших объёмах.

**User Value**: Быстрые отклики даже на слабых устройствах. Читабельные графики без “шума”. Отсутствие падений браузера/вмешательств пользователя.

## Use-case UML диаграммы

![UML диаграмма](assets/Use%20Case%202.png)
<center>Рис. 1 – UML диаграмма</center>
