
# D2 — Use-case Narrative


## UC-1. Получить персональные рекомендации (две ИИ-модели, RAG)

**Акторы:** Пользователь (основной), Система рекомендаций (LLM+RAG), Хранилище векторных документов, Очередь фоновых задач.
**Предусловия:**

* Пользователь зарегистрирован и авторизован.
* Есть валидные данные сна: ≥1 ночь для оценки дня и ≥7 последовательных дней для рекомендаций.
* Сервисы (БД/очередь/векторное хранилище/LLM) работоспособны.
  **Триггер:** Пользователь открывает раздел «Статистика сна».

### Happy Path

1. **Пользователь** авторизуется и попадает в раздел статистики.
2. **Пользователь** загружает пакет данных (если ещё не загружал).
3. **Система** валидирует формат и сохраняет записи.
4. **Бэкенд** агрегирует метрики и вычисляет KPI (длительность, пробуждения, фазы, HRV и др.).
5. **Модель 1 (оценка ночи)** анализирует последнюю ночь и классифицирует: хорошо / удовлетворительно / плохо (даёт краткую сводку).
6. **Модель 2 (LLM+RAG)** формирует запрос с трендами за 7 дней + сводкой Модели 1, извлекает релевантные фрагменты из векторной БД и **генерирует персональный план** (N конкретных шагов + прогноз эффекта).
7. **Система** собирает «Единый отчёт» (сводка за ночь, недельные тренды, список действий), версионирует и показывает пользователю.
   **Ценность:** экономия времени на самоанализ, снижение ошибок за счёт научного контекста, быстрый переход к действиям.

### Альтернативы

**A1. Пользователь не авторизован**

* Обнаружение: нет/истёк токен. → Редирект на вход с сохранением целевого URL.
* **Ценность:** безопасность и бесшовный возврат — не теряется контекст.

**A2. Данных недостаточно для рекомендаций**

* Валидатор видит <7 дней. → Показ «Недостаточно данных», параллельно считаем, если для Модели 1 есть ≥1 ночь.
* **Ценность:** time-to-value даже при холодном старте, ясные требования к данным.

### Ошибки

**E1. Технический сбой** (таймаут LLM/RAG, недоступен векторный поиск)

* Авто-ретрай по backoff; возвращаем безопасный минимум (кэш).
* **Ценность:** непрерывность сервиса, меньше срывов.

**E2. Некорректный ввод** (CSV с неверной структурой, даты вне диапазона, дубликаты)

* Частичный импорт валидных строк; откат только неверных записей.
* **Ценность:** экономия времени, меньше ручной правки.

**E3. Превышение лимитов** (частые запросы генерации, большой объём RAG)

* Квота/очередь; объединение нескольких запросов в «ежедневный план»; показ ETA.
* **Ценность:** стабильность платформы и предсказуемые ожидания.

**Постусловия:** Сохранён версионированный отчёт (сколько данных было валидно обработано); доступен повторный экспорт.
**Критерии приёмки:** ≥N конкретных шагов; прогноз эффектов; время ответа ≤X сек при нормальной нагрузке; корректные ссылки на источники.



## UC-2. Проанализировать хронотип и метаболизм

**Акторы:** Пользователь (основной), Сервис антропометрии и метаболизма (калькулятор BMR), Анализатор хронотипа, Хранилище пользовательских аписей, Очередь фоновых задач.

**Предусловия:**

* Пользователь зарегистрирован и авторизован.
* Заполнены антропометрические данные: вес, рост, дата рождения/возраст, пол.
* В базе присутствуют записи сна за ≥7 дней, для MSFsc — присутствуют «свободные дни»/выходные.
* Сервисы БД/очереди/вычислений работоспособны.

**Триггер:** Пользователь открывает раздел «Хронотип».

### Happy Path (основной успешный сценарий)

1. **Система** читает из профиля валидные антропометрические данные (вес, рост, пол, возраст считается из даты рождения).
2. **Система** загружает записи сна за последнюю неделю и определяет «свободные дни».
3. **Система** нормализует времена «отбой/подъём».
4. **Система** вычисляет BMR на основе пола, возраста, роста и веса.
5. **Система** рассчитывает калории, сожжённые во сне.
6. **Система** вычисляет MSFsc и классифицирует хронотип.
7. **Система** формирует сводку:
   * BMR (ккал/сутки);
   * Калории во сне (ккал/ночь);
   * Хронотип и рекомендуемое окно сна (интервал отбоя/подъёма).
9. **Система** сохраняет результаты, версионирует расчёт (дата, период, методика) и отображает карточку пользователю.

**Ценность:** прозрачные, персональные ориентиры (окно сна, энергетика BMR) → экономия времени на саморазбор, подготовка данных для рекомендаций (UC-1).

### Альтернативные сценарии

**A1. Недостаточно «свободных дней» для MSFsc**

* Обнаружение: <2 «свободных» ночей.
* Действия: **Система** показывает «данных недостаточно» и просит продолжать вносить данные.
* **Ценность:** ясные шаги по улучшению качества входа.

**A2. Определён хронотип, но отсутсвует описание**

* Обнаружение: Отсутвие данных в локальныом файле по этому типу хронотипа.
* Действия: **Система** Показывает тип хронотипа без описания.
* **Ценность:** Пользователь всё равно получает результат - нет путаницы и пустых экранов.

### Сценарии ошибок

**E1. Технический сбой** (недоступна БД/очередь, таймаут вычислений)

* Обработка: ретраи с экспоненциальной задержкой; при повторной ошибке — показ последнего успешного расчёта (если есть).
* **Ценность:** устойчивость и непрерывность сервиса, меньше срывов.

**E2. Некорректный ввод** (вес/рост вне разумных диапазонов, пустые поля)

* Обработка: блокируем сохранение, подсвечиваем поля с подсказками/плейсхолдерами; позволяем частично сохранить валидные данные.
* **Ценность:** снижение ошибок, быстрее до корректного результата без лишних попыток.

**E3. Превышение лимитов** (запрошен период/объём больше, чем поддерживает расчёт хронотипа: >7 ночей)

* Обработка: ограничиваем период (7 дней), применяем агрегации/подвыборку; вычисляется хронотип на этих данных.
* **Ценность:** стабильное время вычисления и предсказуемая нагрузка без «тяжёлых» прогонов; понятные рамки расчёта для пользователя.

**Постусловия:** Сохранены: BMR, калории сна/ночь, тип хронотипа, окна сна соотвествующие хронотипу. Результаты доступны другим кейсам (UC-1 для персональных рекомендаций).


---

## UC-3. Просмотреть статистику сна (агрегаты и визуализация)

**Акторы:** Пользователь, Сервис агрегирования/визуализации, Источник данных.
**Предусловия:** Авторизация; за выбранный период есть данные/агрегаты; сервисы в норме.
**Триггер:** Пользователь открывает раздел «Статистика» и выбирает период.

### Happy Path

1. **Пользователь** открывает «Статистика», выбирает период/фильтры.
2. **Система** загружает агрегаты: латентность, эффективность, фазы (deep/light/REM/awake), индекс фрагментации, качество по дням, регулярность.
3. **Система** отображает интерактивные графики и карточки, даёт детализацию по точкам.
4. **Пользователь** меняет период/фильтры; **Система** перестраивает визуализацию.
**Ценность:** быстрая диагностика трендов, экономия времени на отчёты, меньше ошибок интерпретации.

### Альтернативы

**A1. Нет данных/неполный период**

* Показ «Недостаточно данных», подсказки «что собрать», частичная визуализация доступных метрик.
* **Ценность:** ясные ожидания и польза даже при частичном наборе.

**A2. Очень большой объём данных**

* Применяем подвыборку/пагинацию/агрегацию по дням.
* **Ценность:** стабильная скорость и читаемость графиков.

### Ошибки

**E1. Технический сбой** (таймауты БД/отрисовки, падение фонового агрегатора)

* Показ сообщения, о длительной загрузки данных; авто-ретрай в фоне.
* **Ценность:** прозрачность и сохранение контроля у пользователя.

**E2. Некорректный ввод** (некорректный диапазон дат, неверные фильтры)

* Валидация на форме, подсветка ошибок, разумные дефолты (например, последние 7 дней).
* **Ценность:** меньше ошибок и пустых экранов.

**E3. Превышение лимитов** (слишком много точек для отображения)

* Серверная агрегация по «бакетам» 1–2 минуты для метрик с близкими метками времени (±1–2 мин)
* **Ценность:** быстрый рендер без «фризов» браузера, читабельные графики без шума дубликатов.



## Use-case UML диаграммы

![UML диаграмма]([assets/Use%20Case%202.png](https://github.com/vstu-sii/bachelor-2025-team-horns_and_hooves/blob/D2/docs/assets/UseCase2.png))
<center>Рис. 1 – UML диаграмма</center>
