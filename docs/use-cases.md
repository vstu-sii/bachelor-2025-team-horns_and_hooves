# D2 — Use-case Narrative

## UC-1. Получить персональные рекомендации

**Акторы:** Пользователь (основной), Устройство-трекер (внешний источник данных).

**Предусловия:**

* Пользователь зарегистрирован и авторизован.
* Доступны данные сна: ≥1 ночь (для оценки дня) и ≥7 последовательных дней (для рекомендаций).
* Система доступна для запросов пользователя.

**Триггер:** Пользователь запрашивает персональные рекомендации по улучшению сна.

### Happy Path

1. **Пользователь** запрашивает персональные рекомендации.
2. **Система** проверяет, что за последние 7 дней есть достаточный объём валидных записей сна.
3. **Система** анализирует последнюю ночь и недельные тренды (длительность, фазы, пробуждения, пульс и др.).
4. **Система** учитывает индивидуальные данные профиля (возраст, пол, рост, вес) и ограничения пользователя.
5. **Система** формирует персональный план: не менее *N* конкретных шагов с ориентировочными эффектами.
6. **Система** фиксирует результат в истории пользователя и предоставляет его для просмотра.

**Ценность:** экономия времени на самостоятельный поиск и интерпретацию; снижение ошибок за счёт персонализации и учёта недельных трендов.


### Альтернативы

**A1. Пользователь не авторизован**

* Обнаружение: отсутствует активная сессия. → Предложить пройти авторизацию; после входа вернуться к запросу рекомендаций.
* **Ценность:** безопасность и бесшовный возврат к цели без потери контекста.

**A2. Данных за 7 дней недостаточно**

* Обнаружение: валидных записей < 7. → Показать «Недостаточно данных», предложить краткий старт-план на общих нормах и список, какие записи собрать для полной персонализации.
* **Ценность:** быстрый первый результат («time-to-value») и понятные ожидания по данным.

### Ошибки

**E1. Технический сбой** (временная недоступность функции рекомендаций)

* Обработка: сообщить о временной недоступности; предложить повторить запрос позднее; сохранить черновик состояния запроса.
* **Ценность:** прозрачность и предсказуемость, меньше фрустрации.

**E2. Некорректный ввод данных при загрузке** (неверный формат/диапазоны/дубликаты)

* Обработка: выполнить частичный импорт валидных строк; указать, что именно исправить; повторный запуск проверки после корректировки.
* **Ценность:** экономия времени пользователя и снижение «мусорных» данных.

**E3. Превышение лимитов** (слишком частые запросы рекомендаций)

* Обработка: сообщить о допустимой частоте; показать последнюю актуальную рекомендацию; предложить дождаться обновления через заданный интервал.
* **Ценность:** стабильность сервиса и предсказуемые ожидания.

**Постусловия:** Персональные рекомендации сохранены в истории пользователя и доступны для повторного просмотра.
**Критерии приёмки:** В ответе ≥ *N* конкретных шагов; есть прогноз ожидаемого эффекта; учтены недельные тренды и профиль; время получения результата ≤ *X* сек при нормальной нагрузке.

---

## UC-2. Проанализировать хронотип и метаболизм

**Акторы:** Пользователь (основной), Устройство-трекер (внешний источник данных).

**Предусловия:**

* Пользователь зарегистрирован и авторизован.
* Антропометрия заполнена при регистрации и валидна (вес, рост, дата рождения → возраст, пол).
* В наличии записи сна за ≥7 дней; для корректной оценки середины сна предпочтительны «свободные дни».
* Система доступна для запросов пользователя.

**Триггер:** Пользователь запрашивает анализ хронотипа и метаболизма.

### Happy Path

1. **Система** использует сохранённые антропометрические данные профиля.
2. **Система** определяет набор записей сна за выбранный период и выделяет «свободные дни».
3. **Система** сопоставляет время отбоя/подъёма и рассчитывает середину сна.
4. **Система** рассчитывает базовый уровень энергозатрат (BMR) и ориентировочные калории, израсходованные во время сна.
5. **Система** вычисляет скорректированную середину сна и определяет хронотип (например, «жаворонок», «голубь», «сова»).
6. **Система** формирует сводку: значения BMR и калорий сна, тип хронотипа и рекомендуемое окно сна (интервалы отбоя/подъёма).
7. **Система** сохраняет результат анализа и предоставляет пользователю сводку.

**Ценность:** персональные ориентиры по режиму сна и энергетике; экономия времени на самостоятельные расчёты; база для последующих рекомендаций.

### Альтернативы

**A1. Недостаточно «свободных дней»**

* Обнаружение: «свободных» ночей слишком мало для надёжной оценки. → Показать «Точность снижена», выдать оценку по доступным дням и подсказать, какие записи помогут улучшить точность.
* **Ценность:** непрерывная польза даже при неполных данных; ясные шаги по улучшению.

**A2. Определён хронотип, но отсутствует текстовое описание**

* Обнаружение: для определённого типа нет локализованного описания. → Показать тип и рассчитанное время середины сна; уведомить, что текстовое описание недоступно.
* **Ценность:** пользователь получает результат (без «пустого экрана») и понимает, что именно отсутствует.

### Ошибки

**E1. Технический сбой** (временная недоступность функции анализа)

* Обработка: сообщить о временной недоступности; предложить повторить запрос позднее; показать последний успешный результат, если он есть.
* **Ценность:** непрерывность работы и предсказуемость.

**E2. Некорректные данные профиля** (пустые/нереалистичные значения)

* Обработка: сообщить, какие поля профиля нужно уточнить; предложить обновить профиль и повторить анализ.
* **Ценность:** снижение ошибок расчёта; быстрый путь к корректному результату.

**E3. Превышение лимитов набора данных** (запрошен объём больше поддерживаемого вычислением хронотипа)

* Обработка: выполнить анализ по последним 7 записям; уведомить, что применён лимит периода; при дефиците «свободных» ночей — отразить сниженную точность.
* **Ценность:** предсказуемое время расчёта и понятные границы анализа.

**Постусловия:** Сохранены BMR, калории сна, тип хронотипа и рекомендуемое окно сна; результат доступен для последующего использования в рекомендациях.
**Критерии приёмки:** Возвращены численные значения BMR и калорий сна, тип хронотипа и окно сна; при дефиците «свободных» дней отображается пониженная точность; время получения результата ≤ *X* сек при периоде ≤ *Y* дней.

---

## UC-3. Просмотреть статистику сна

**Акторы:** Пользователь (основной), Устройство-трекер (внешний источник данных).
**Предусловия:**

* Пользователь зарегистрирован и авторизован.
* За выбранный период есть данные/агрегаты.
* Система доступна для запросов пользователя.
  **Триггер:** Пользователь запрашивает статистику за период.

### Happy Path

1. **Пользователь** выбирает период и параметры просмотра.
2. **Система** готовит агрегированные показатели за период (латентность, эффективность сна, распределение фаз, индекс фрагментации, качество по дням, регулярность).
3. **Система** предоставляет пользовательский обзор: графики и сводные показатели с возможностью уточнить период/параметры.
4. **Пользователь** изменяет период/параметры; **Система** обновляет обзор.

**Ценность:** быстрая диагностика трендов; экономия времени на подготовку отчётов; снижение ошибок интерпретации.

### Альтернативы

**A1. Недостаточно данных для выбранного периода**

* Предложить расширить период или собрать недостающие записи; показать частичный обзор, если это возможно.
* **Ценность:** понятные ожидания и польза даже при неполном наборе.

**A2. Очень большой период**

* Предложить предустановленные интервалы и укрупнённый обзор.
* **Ценность:** стабильная скорость и читаемость показателей.

### Ошибки

**E1. Технический сбой** (временная недоступность статистики)

* Обработка: сообщить о задержке; предложить повторить запрос; при возможности показать сохранённый ранее обзор.
* **Ценность:** прозрачность, сохранение контроля у пользователя.

**E2. Некорректный ввод** (выбран недопустимый период: будущая неделя/месяц или период раньше даты первой записи/регистрации)

* **Обработка:** система автоматически переходит к ближайшему доступному периоду (последняя доступная неделя/месяц в будущем направлении или первая доступная в прошлом) и сообщает, что выбранный период недоступен; предлагает перейти к «последнему доступному периоду» или «первой доступной записи».
* **Ценность:** меньше «пустых» экранов и лишних действий, экономия времени на навигацию, понятные границы доступной истории.


**E3. Превышение лимитов** (слишком много точек для отображения графиков)

* Обработка: объединять близкие по времени точки в усреднённые интервалы (например, в пределах нескольких минут), по возможности сохраняя сведения о диапазонах значений в интервале.
* **Ценность:** быстрый отклик без «подвисаний» и читаемые графики без шума дубликатов.

**Постусловия:** Выбранный период и параметры сохраняются как предпочтения пользователя; обзор доступен для повторного просмотра.
**Критерии приёмки:** Загрузка обзора ≤ *X* сек при объёме данных ≤ *Y* записей; корректная смена периода/параметров без срыва просмотра; при укрупнении серии указано, что данные агрегированы.

---

